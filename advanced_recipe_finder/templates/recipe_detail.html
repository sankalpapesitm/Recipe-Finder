{% extends "base.html" %}

{% block title %}{{ recipe.title }}{% endblock %}

{% block content %}
<style>
    .list-group-item {
        white-space: normal !important;
        word-break: keep-all;
    }
    .ingredients-list .list-group-item {
        display: flex;
        align-items: center;
    }
</style>
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <img src="{{ recipe.image_url if recipe.image_url.startswith('http') else url_for('uploaded_file', filename=recipe.image_url) if recipe.image_url else url_for('static', filename='hero-image.png') }}" class="d-block mx-auto rounded" alt="{{ recipe.title }}" loading="lazy" style="width: 512px; height: 512px; object-fit: cover;">
                <div class="card-body">
                    <h1 class="card-title">{{ recipe.title }}</h1>
                    
                    <div class="d-flex justify-content-around text-center mb-4 p-3 bg-light rounded">
                        <span><i class="fas fa-clock me-1"></i> 
                        {% if recipe.cooking_time %}
                            {% if recipe.cooking_time >= 60 %}
                                {{ recipe.cooking_time // 60 }} hour{{ 's' if recipe.cooking_time // 60 > 1 else '' }}{% if recipe.cooking_time % 60 > 0 %} {{ recipe.cooking_time % 60 }} minutes{% endif %}
                            {% else %}
                                {{ recipe.cooking_time }} minutes
                            {% endif %}
                        {% else %}
                            Not specified
                        {% endif %}
                        </span>
                        <span><i class="fas fa-tachometer-alt me-1"></i> {{ recipe.difficulty }}</span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button id="read-recipe-btn" class="btn btn-primary me-2"><i class="fas fa-volume-up"></i> Read Recipe</button>
                            {% if is_favorite %}
                            <button class="btn btn-danger" onclick="toggleFavorite({{ recipe.id }})"><i class="fas fa-heart"></i> Remove from Favorites</button>
                            {% else %}
                            <button class="btn btn-outline-danger" onclick="toggleFavorite({{ recipe.id }})"><i class="far fa-heart"></i> Add to Favorites</button>
                            {% endif %}
                        </div>
                        <div class="rating">
                            {% for i in range(1, 6) %}
                                <i class="fa{{ 's' if user_rating and i <= user_rating else 'r' }} fa-star text-warning star-rating" data-rating="{{ i }}" onclick="selectStar({{ i }}, {{ recipe.id }})" style="cursor: pointer;"></i>
                            {% endfor %}
                            <button id="submit-rating-btn" class="btn btn-sm btn-primary ms-2" onclick="submitRating({{ recipe.id }})" style="display: none;">Submit Rating</button>
                            <span class="text-muted ms-2">({{ "%.1f"|format(average_rating) if average_rating else "0.0" }} average)</span>
                            {% if user_rating %}
                            <span class="text-muted ms-2">Your rating: {{ user_rating }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ingredients and Instructions Side by Side -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h5>Ingredients</h5>
                            <ul class="list-group mb-3 ingredients-list">
                                {% for ingredient in recipe.ingredients %}
                                <li class="list-group-item">{{ ingredient|replace('\n', ' ')|replace('<br>', ' ')|replace('<br/>', ' ') }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Instructions</h5>
                            <ol class="list-group list-group-numbered mb-3">
                                {% for instruction in recipe.instructions %}
                                <li class="list-group-item">{{ instruction }}</li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>

                    {% if recipe.nutritional_info %}
                    <h5 class="mt-4 mb-3">Nutritional Information (per serving)</h5>
                    <div class="text-center mb-3">
                        {% set nutrition_order = ['servings', 'calories_per_serving', 'calories', 'protein', 'fat', 'carbohydrates'] %}
                        {% for key in nutrition_order %}
                            {% if key in recipe.nutritional_info %}
                                <span style="margin: 0 1.5rem;"><strong style="text-transform: capitalize;">{{ key.replace('_', ' ').replace('calories per serving', 'Calories Per Serving') }}:</strong> {{ recipe.nutritional_info[key] }}</span>
                            {% endif %}
                        {% endfor %}
                        {% for key, value in recipe.nutritional_info.items() %}
                            {% if key not in nutrition_order %}
                                <span style="margin: 0 1.5rem;"><strong style="text-transform: capitalize;">{{ key.replace('_', ' ') }}:</strong> {{ value }}</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
        </div>
    </div>
</div>

<!-- Hidden audio player for recipe audio -->
<audio id="recipeAudioPlayer" style="display: none;"></audio>
{% endblock %}

{% block extra_js %}
<script>
    // Recipe data for audio generation
    const recipeData = {
        title: {{ recipe.title | tojson }},
        ingredients: {{ recipe.ingredients | tojson }},
        instructions: {{ recipe.instructions | tojson }},
        audio_url: {{ recipe.audio_url | tojson if recipe.audio_url else 'null' }}
    };

    var averageRating = {{ "%.1f"|format(average_rating) if average_rating else "0.0" }};
    let currentRating = {{ user_rating or 0 }};
    let selectedRating = 0;
    let feedbackRating = 0;
    let isInitializing = true;

    // Initialize stars on page load if user has a rating
    window.addEventListener('DOMContentLoaded', function() {
        {% if user_rating %}
        // Display the saved rating
        const stars = document.querySelectorAll('.star-rating');
        stars.forEach((star, index) => {
            if (index < {{ user_rating }}) {
                star.classList.remove('far');
                star.classList.add('fas');
            } else {
                star.classList.remove('fas');
                star.classList.add('far');
            }
        });
        // Keep selectedRating at 0 for proper toggle functionality
        selectedRating = 0;
        {% endif %}
        isInitializing = false;
    });

    function toggleFavorite(recipeId) {
        fetch(`/toggle_favorite/${recipeId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const button = document.querySelector(`button[onclick="toggleFavorite(${recipeId})"]`);
                if (data.action === 'added') {
                    button.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
                    button.classList.remove('btn-outline-danger');
                    button.classList.add('btn-danger');
                } else {
                    button.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-outline-danger');
                }
            } else {
                alert(data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function selectStar(rating, recipeId) {
        // Check if clicking the same star that's currently selected or the current rating
        const clickingSameStar = selectedRating === rating;
        const clickingCurrentRating = selectedRating === 0 && currentRating === rating;
        
        // Toggle: remove rating if clicking same star
        if (clickingSameStar || clickingCurrentRating) {
            selectedRating = 0;
            // Remove all stars
            const stars = document.querySelectorAll('.star-rating');
            stars.forEach((star) => {
                star.classList.remove('fas');
                star.classList.add('far');
            });
            // Show submit button if zero rating is different from current rating
            if (currentRating !== 0) {
                document.getElementById('submit-rating-btn').style.display = 'inline-block';
            } else {
                document.getElementById('submit-rating-btn').style.display = 'none';
            }
        } else {
            // Set new rating
            selectedRating = rating;
            const stars = document.querySelectorAll('.star-rating');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });

            // Show submit button if rating is different from current, hide if same
            if (rating !== currentRating) {
                document.getElementById('submit-rating-btn').style.display = 'inline-block';
            } else {
                document.getElementById('submit-rating-btn').style.display = 'none';
            }
        }
    }

    function selectFeedbackStar(rating) {
        feedbackRating = rating;
        const stars = document.querySelectorAll('.feedback-star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.remove('far');
                star.classList.add('fas');
            } else {
                star.classList.remove('fas');
                star.classList.add('far');
            }
        });

        // Update feedback rating text
        const feedbackText = document.getElementById('feedback-rating-text');
        feedbackText.textContent = `Selected rating: ${rating}`;
    }

    function submitRating(recipeId) {
        // Allow zero rating (removal of rating) but check if selectedRating is properly set
        if (selectedRating < 0) {
            alert('Please select a rating first');
            return;
        }

        // Submit the rating via AJAX
        fetch(`/submit_review/${recipeId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `rating=${selectedRating}&comment=`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Rating submitted successfully!');
                // Hide the submit button
                document.getElementById('submit-rating-btn').style.display = 'none';
                // Update current rating to the newly submitted rating
                currentRating = selectedRating;
                // Reset selectedRating to 0 so toggle works properly on next click
                selectedRating = 0;
                // Update the user's rating display without reloading
                const userRatingSpan = document.querySelector('.rating .text-muted:last-child');
                if (!userRatingSpan || !userRatingSpan.textContent.includes('Your rating:')) {
                    const newSpan = document.createElement('span');
                    newSpan.className = 'text-muted ms-2';
                    newSpan.textContent = `Your rating: ${currentRating}`;
                    document.querySelector('.rating').appendChild(newSpan);
                } else {
                    userRatingSpan.textContent = `Your rating: ${currentRating}`;
                }
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function selectRating(rating) {
        document.getElementById('selectedRating').value = rating;
        const stars = document.querySelectorAll('.star-input');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.remove('far');
                star.classList.add('fas');
            } else {
                star.classList.remove('fas');
                star.classList.add('far');
            }
        });
    }

    function submitFeedback(recipeId) {
        const comment = document.getElementById('comment').value;

        if (!comment.trim()) {
            alert('Please enter your feedback');
            return;
        }

        fetch(`/submit_review/${recipeId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `rating=${feedbackRating}&comment=${encodeURIComponent(comment)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Feedback submitted successfully!');
                // Clear the form
                document.getElementById('comment').value = '';
                // Update current rating if a rating was selected in feedback
                if (feedbackRating > 0) {
                    currentRating = feedbackRating;
                    // Reset selectedRating to 0 so toggle works properly
                    selectedRating = 0;
                    // Update the user's rating display
                    const userRatingSpan = document.querySelector('.rating .text-muted:last-child');
                    if (!userRatingSpan || !userRatingSpan.textContent.includes('Your rating:')) {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'text-muted ms-2';
                        newSpan.textContent = `Your rating: ${feedbackRating}`;
                        document.querySelector('.rating').appendChild(newSpan);
                    } else {
                        userRatingSpan.textContent = `Your rating: ${feedbackRating}`;
                    }
                    // Update visual stars in main rating section
                    const stars = document.querySelectorAll('.star-rating');
                    stars.forEach((star, index) => {
                        if (index < feedbackRating) {
                            star.classList.remove('far');
                            star.classList.add('fas');
                        } else {
                            star.classList.remove('fas');
                            star.classList.add('far');
                        }
                    });
                    // Hide submit button since rating is now current
                    document.getElementById('submit-rating-btn').style.display = 'none';
                }
                // Reset feedback rating
                feedbackRating = 0;
                // Reset feedback stars
                const feedbackStars = document.querySelectorAll('.feedback-star');
                feedbackStars.forEach((star) => {
                    star.classList.remove('fas');
                    star.classList.add('far');
                });
                // Update feedback rating text
                const feedbackText = document.getElementById('feedback-rating-text');
                feedbackText.textContent = `Your current rating: ${currentRating}`;
                // Reload the page to update the average rating
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Read Recipe button logic
    const readRecipeBtn = document.getElementById('read-recipe-btn');
    const audioPlayer = document.getElementById('recipeAudioPlayer');
    let isReading = false;
    let speechSynthesis = window.speechSynthesis;
    
    if (readRecipeBtn) {
        readRecipeBtn.addEventListener('click', function() {
            // If already saved audio exists, play it
            if (recipeData.audio_url) {
                if (isReading) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                    readRecipeBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read Recipe';
                    isReading = false;
                } else {
                    audioPlayer.src = recipeData.audio_url;
                    audioPlayer.play();
                    readRecipeBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Reading';
                    isReading = true;
                    
                    audioPlayer.onended = function() {
                        readRecipeBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read Recipe';
                        isReading = false;
                    };
                }
                return;
            }
            
            // If no saved audio, use browser TTS
            if (isReading) {
                // Stop current reading
                speechSynthesis.cancel();
                readRecipeBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read Recipe';
                readRecipeBtn.disabled = false;
                isReading = false;
                return;
            }
            
            // Create speech text
            const speechText = createSpeechText();
            useBrowserTTS(speechText);
        });
        
        function createSpeechText() {
            let text = `Recipe: ${recipeData.title}. `;
            
            if (recipeData.ingredients && recipeData.ingredients.length > 0) {
                text += 'Ingredients: ' + recipeData.ingredients.map(ing => expandAbbreviations(ing)).join(', ') + '. ';
            }
            
            if (recipeData.instructions && recipeData.instructions.length > 0) {
                text += 'Instructions: ';
                recipeData.instructions.forEach((step, index) => {
                    text += `Step ${index + 1}: ${expandAbbreviations(step)}. `;
                });
            }
            
            return text;
        }
        
        function expandAbbreviations(text) {
            // Expand common cooking measurement abbreviations
            // Handle patterns like "200g" -> "200 grams"
            text = text.replace(/(\d+)\s*g\b/gi, '$1 grams');
            text = text.replace(/(\d+)\s*kg\b/gi, '$1 kilograms');
            text = text.replace(/(\d+)\s*mg\b/gi, '$1 milligrams');
            text = text.replace(/(\d+)\s*oz\b/gi, '$1 ounces');
            text = text.replace(/(\d+)\s*lbs?\b/gi, '$1 pounds');
            text = text.replace(/(\d+)\s*ml\b/gi, '$1 milliliters');
            text = text.replace(/(\d+)\s*l\b/gi, '$1 liters');
            text = text.replace(/(\d+)\s*tsp\b/gi, '$1 teaspoon');
            text = text.replace(/(\d+)\s*tbsp\b/gi, '$1 tablespoon');
            text = text.replace(/(\d+)\s*mins?\b/gi, '$1 minutes');
            text = text.replace(/(\d+)\s*hrs?\b/gi, '$1 hours');
            text = text.replace(/(\d+)\s*secs?\b/gi, '$1 seconds');
            
            // Handle standalone abbreviations (without numbers)
            text = text.replace(/\btsp\b/gi, 'teaspoon');
            text = text.replace(/\btbsp\b/gi, 'tablespoon');
            text = text.replace(/\bcups?\b/gi, 'cup');
            text = text.replace(/\bpt\b/gi, 'pint');
            text = text.replace(/\bqt\b/gi, 'quart');
            text = text.replace(/\bgal\b/gi, 'gallon');
            
            // Temperature
            text = text.replace(/(\d+)\s*°?\s*F\b/gi, '$1 degrees Fahrenheit');
            text = text.replace(/(\d+)\s*°?\s*C\b/gi, '$1 degrees Celsius');
            
            return text;
        }
        
        function useBrowserTTS(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.onstart = function() {
                readRecipeBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Reading';
                readRecipeBtn.disabled = false;
                isReading = true;
            };
            
            utterance.onend = function() {
                readRecipeBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read Recipe';
                isReading = false;
            };
            
            utterance.onerror = function(event) {
                console.error('Speech synthesis error:', event);
                readRecipeBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read Recipe';
                readRecipeBtn.disabled = false;
                isReading = false;
                alert('Sorry, text-to-speech is not available on your device.');
            };
            
            speechSynthesis.speak(utterance);
        }
    }
</script>
{% endblock %}
